<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ˆì¼“ ë‰´ìŠ¤ â€” HerdVibe</title>
  <meta name="description" content="ì‹¤ì‹œê°„ ê¸€ë¡œë²Œ ë§ˆì¼“ ë‰´ìŠ¤ë¥¼ í•œê¸€ë¡œ. ì•”í˜¸í™”í, ë¯¸êµ­ ì£¼ì‹, ë§¤í¬ë¡œ ë‰´ìŠ¤ë¥¼ ë§¤ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-primary: #000000;
      --bg-card: #111111;
      --bg-card-hover: #1a1a1a;
      --bg-surface: #0a0a0a;
      --border: #222222;
      --border-glow: #333333;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --text-muted: #666666;
      --accent-crypto: #f59e0b;
      --accent-crypto-bg: rgba(245, 158, 11, 0.1);
      --accent-stocks: #3b82f6;
      --accent-stocks-bg: rgba(59, 130, 246, 0.1);
      --accent-macro: #ef4444;
      --accent-macro-bg: rgba(239, 68, 68, 0.1);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* â”€â”€â”€ í—¤ë” â”€â”€â”€ */
    .header {
      padding: 40px 0 28px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    .header h1 {
      font-size: 26px;
      font-weight: 900;
      color: #ffffff;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }
    .subtitle { color: var(--text-secondary); font-size: 14px; }
    .update-time {
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 8px;
    }

    /* â”€â”€â”€ í•„í„° íƒ­ â”€â”€â”€ */
    .filter-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 20px 0;
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      z-index: 10;
      border-bottom: 1px solid var(--border);
    }
    .filter-btn {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      font-weight: 500;
      padding: 8px 18px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .filter-btn:hover { border-color: var(--border-glow); color: #ffffff; }
    .filter-btn.active { color: #ffffff; border-color: transparent; }
    .filter-btn[data-filter="all"].active { background: #333333; }
    .filter-btn[data-filter="crypto"].active { background: linear-gradient(135deg, #92400e, #b45309); }
    .filter-btn[data-filter="stocks"].active { background: linear-gradient(135deg, #1e40af, #2563eb); }
    .filter-btn[data-filter="macro"].active { background: linear-gradient(135deg, #991b1b, #dc2626); }
    .filter-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      margin-left: 4px;
      opacity: 0.7;
    }

    /* â”€â”€â”€ ì‹œê°„ ê·¸ë£¹ â”€â”€â”€ */
    .time-group { margin-top: 24px; }
    .time-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 0;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .time-label::before,
    .time-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* â”€â”€â”€ ë‰´ìŠ¤ ì¹´ë“œ â”€â”€â”€ */
    .news-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 12px;
      transition: all 0.2s ease;
    }
    .news-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-glow);
    }
    .news-card.crypto { border-left: 3px solid var(--accent-crypto); }
    .news-card.stocks { border-left: 3px solid var(--accent-stocks); }
    .news-card.macro { border-left: 3px solid var(--accent-macro); }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .card-meta { display: flex; align-items: center; gap: 8px; }

    .category-tag {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      letter-spacing: 0.3px;
    }
    .category-tag.crypto { color: var(--accent-crypto); background: var(--accent-crypto-bg); }
    .category-tag.stocks { color: var(--accent-stocks); background: var(--accent-stocks-bg); }
    .category-tag.macro { color: var(--accent-macro); background: var(--accent-macro-bg); }

    .card-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ì˜ë¬¸ ì œëª© (íšŒìƒ‰ ì‘ê²Œ) */
    .card-title-en {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    /* í•œê¸€ ìš”ì•½ */
    .card-summary-kr {
      font-size: 15px;
      font-weight: 500;
      color: #ffffff;
      line-height: 1.7;
      margin-bottom: 12px;
    }

    .card-summary-kr.fallback {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 400;
    }

    /* ì¶œì²˜ ë§í¬ */
    .card-source {
      font-size: 12px;
      color: var(--text-muted);
    }
    .card-source a {
      color: var(--accent-stocks);
      text-decoration: none;
      transition: opacity 0.2s;
    }
    .card-source a:hover { opacity: 0.8; }

    .card-media {
      margin: 12px 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
      max-height: 240px;
    }
    .card-media img {
      width: 100%;
      height: auto;
      max-height: 240px;
      object-fit: cover;
      display: block;
    }

    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .engagement {
      display: flex;
      gap: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
    }
    .engagement span { display: flex; align-items: center; gap: 4px; }

    .currencies { display: flex; gap: 4px; }
    .currency-pill {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--bg-surface);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .loading { text-align: center; padding: 80px 0; color: var(--text-muted); }
    .loading-spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent-crypto);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 60px 0; color: var(--text-muted); font-size: 14px; }

    .footer {
      text-align: center;
      padding: 40px 0;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }
    .footer p { font-size: 12px; color: var(--text-muted); }
    .footer a { color: var(--accent-stocks); text-decoration: none; }

    @media (max-width: 640px) {
      .header { padding: 24px 0 20px; }
      .header h1 { font-size: 22px; }
      .filter-bar { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .filter-bar::-webkit-scrollbar { display: none; }
      .news-card { padding: 16px; }
      .card-summary-kr { font-size: 14px; }
      .card-title-en { font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>ë§ˆì¼“ ë‰´ìŠ¤</h1>
      <p class="subtitle">ê¸€ë¡œë²Œ ë§ˆì¼“ ë‰´ìŠ¤ë¥¼ í•œê¸€ë¡œ í•´ì„ Â· ë§¤ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸</p>
      <p class="update-time" id="updateTime">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </header>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">
        ì „ì²´ <span class="filter-count" id="countAll"></span>
      </button>
      <button class="filter-btn" data-filter="crypto">
        ì•”í˜¸í™”í <span class="filter-count" id="countCrypto"></span>
      </button>
      <button class="filter-btn" data-filter="stocks">
        ì£¼ì‹ <span class="filter-count" id="countStocks"></span>
      </button>
      <button class="filter-btn" data-filter="macro">
        ë§¤í¬ë¡œ <span class="filter-count" id="countMacro"></span>
      </button>
    </div>

    <main id="newsFeed">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>ë§ˆì¼“ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </main>

    <footer class="footer">
      <p>Powered by <a href="https://herdvibe.com" target="_blank">HerdVibe</a></p>
      <p style="margin-top: 6px;">ë°ì´í„°ëŠ” ìë™ ìˆ˜ì§‘ë˜ë©° íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
    </footer>
  </div>

  <script>
    var DATA_URL = 'data/market-pulse.json';
    var REFRESH_INTERVAL = 5 * 60 * 1000;
    var allItems = [];
    var currentFilter = 'all';

    async function loadData() {
      try {
        var resp = await fetch(DATA_URL + '?t=' + Date.now());
        if (!resp.ok) throw new Error('Failed');
        var data = await resp.json();
        allItems = data.items || [];
        document.getElementById('updateTime').textContent =
          'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.last_updated_kst || 'ì•Œ ìˆ˜ ì—†ìŒ');
        updateCounts();
        renderFeed();
      } catch (err) {
        document.getElementById('newsFeed').innerHTML =
          '<div class="empty-state">' +
            '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>' +
            '<p style="margin-top:8px;font-size:12px;">data/market-pulse.json íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>' +
          '</div>';
      }
    }

    function updateCounts() {
      var counts = { all: allItems.length, crypto: 0, stocks: 0, macro: 0 };
      allItems.forEach(function(item) {
        var cat = item.category || 'crypto';
        if (counts[cat] !== undefined) counts[cat]++;
      });
      document.getElementById('countAll').textContent = counts.all;
      document.getElementById('countCrypto').textContent = counts.crypto;
      document.getElementById('countStocks').textContent = counts.stocks;
      document.getElementById('countMacro').textContent = counts.macro;
    }

    function renderFeed() {
      var feed = document.getElementById('newsFeed');
      var filtered = currentFilter === 'all'
        ? allItems
        : allItems.filter(function(item) { return item.category === currentFilter; });

      if (filtered.length === 0) {
        feed.innerHTML = '<div class="empty-state"><p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        return;
      }

      var groups = groupByTime(filtered);
      var html = '';
      groups.forEach(function(entry) {
        html += '<div class="time-group"><div class="time-label">' + entry[0] + '</div>' +
          entry[1].map(renderCard).join('') + '</div>';
      });
      feed.innerHTML = html;
    }

    function groupByTime(items) {
      var groups = [];
      var groupMap = {};
      var now = new Date();
      items.forEach(function(item) {
        var date = new Date(item.fetched_at || item.published_at || now);
        var diff = (now - date) / (1000 * 60 * 60);
        var label;
        if (diff < 1) label = 'ë°©ê¸ˆ ì „';
        else if (diff < 24) label = Math.floor(diff) + 'ì‹œê°„ ì „';
        else {
          label = date.toLocaleDateString('ko-KR', {
            month: 'short', day: 'numeric', weekday: 'short'
          });
        }
        if (!groupMap[label]) {
          groupMap[label] = [];
          groups.push([label, groupMap[label]]);
        }
        groupMap[label].push(item);
      });
      return groups;
    }

    function renderCard(item) {
      var cat = item.category || 'crypto';
      var catLabel = { crypto: 'ì•”í˜¸í™”í', stocks: 'ì£¼ì‹', macro: 'ë§¤í¬ë¡œ' }[cat] || 'ë‰´ìŠ¤';

      // í•œê¸€ ìš”ì•½ (ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ì˜ë¬¸ ìš”ì•½ í‘œì‹œ)
      var summaryText = item.korean_summary || item.body_preview || '';
      var summaryClass = item.korean_summary ? 'card-summary-kr' : 'card-summary-kr fallback';

      // ë¯¸ë””ì–´
      var mediaHtml = item.media_url
        ? '<div class="card-media"><img src="' + esc(item.media_url) + '" alt="" loading="lazy" /></div>' : '';

      // ì†Œì…œ ì°¸ì—¬ë„ (íŠ¸ìœ—ì¸ ê²½ìš°)
      var engHtml = '';
      if (item.likes || item.retweets) {
        engHtml = '<div class="engagement">';
        if (item.likes) engHtml += '<span>â™¥ ' + fmtNum(item.likes) + '</span>';
        if (item.retweets) engHtml += '<span>ğŸ” ' + fmtNum(item.retweets) + '</span>';
        engHtml += '</div>';
      } else {
        engHtml = '<div></div>';
      }

      // ì½”ì¸ íƒœê·¸
      var curHtml = (item.currencies || []).slice(0, 4).map(function(c) {
        return '<span class="currency-pill">' + esc(c) + '</span>';
      }).join('');

      // ì¶œì²˜ ë§í¬
      var sourceHtml = '';
      if (item.source_url && item.source_name) {
        sourceHtml = '<div class="card-source">ì¶œì²˜: <a href="' + esc(item.source_url) + '" target="_blank" rel="noopener">' + esc(item.source_name) + '</a></div>';
      } else if (item.source_url) {
        var domain = '';
        try { domain = new URL(item.source_url).hostname.replace('www.', ''); } catch(e) { domain = 'ì›ë¬¸'; }
        sourceHtml = '<div class="card-source">ì¶œì²˜: <a href="' + esc(item.source_url) + '" target="_blank" rel="noopener">' + esc(domain) + '</a></div>';
      }

      return '<article class="news-card ' + cat + '">' +
        '<div class="card-header"><div class="card-meta">' +
          '<span class="category-tag ' + cat + '">' + catLabel + '</span>' +
        '</div></div>' +
        '<div class="card-title-en">' + esc(item.title || '') + '</div>' +
        mediaHtml +
        (summaryText ? '<div class="' + summaryClass + '">' + esc(summaryText) + '</div>' : '') +
        sourceHtml +
        (curHtml || engHtml ? '<div class="card-footer">' + engHtml +
          '<div class="currencies">' + curHtml + '</div></div>' : '') +
      '</article>';
    }

    function esc(s) {
      if (!s) return '';
      var m = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(s).replace(/[&<>"']/g, function(c) { return m[c]; });
    }

    function fmtNum(n) {
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return String(n);
    }

    document.querySelectorAll('.filter-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderFeed();
      });
    });

    loadData();
    setInterval(loadData, REFRESH_INTERVAL);
  </script>
</body>
</html>
